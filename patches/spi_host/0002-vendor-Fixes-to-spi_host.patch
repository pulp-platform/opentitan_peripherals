From 55ab322b3120cfe453bb1a444870e9cc9a8b128d Mon Sep 17 00:00:00 2001
From: Christopher Reinwardt <creinwar@ethz.ch>
Date: Mon, 23 Jan 2023 13:06:53 +0100
Subject: [PATCH] vendor: Fixes to spi_host

---
 rtl/spi_host_byte_merge.sv | 2 +-
 rtl/spi_host_fsm.sv        | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/rtl/spi_host_byte_merge.sv b/rtl/spi_host_byte_merge.sv
index bc9cd0121..ef7114160 100644
--- a/rtl/spi_host_byte_merge.sv
+++ b/rtl/spi_host_byte_merge.sv
@@ -54,7 +54,7 @@ module spi_host_byte_merge (
     .clk_i,
     .rst_ni,
     .clr_i    (clr),
-    .wdata_i  (byte_i),
+    .wdata_i  (do_fill ? '0 : byte_i),
     .wvalid_i (byte_valid),
     .wready_o (byte_ready),
     .rdata_o  (word_o),
diff --git a/rtl/spi_host_fsm.sv b/rtl/spi_host_fsm.sv
index 3e01bff99..e0106374e 100644
--- a/rtl/spi_host_fsm.sv
+++ b/rtl/spi_host_fsm.sv
@@ -487,7 +487,7 @@ module spi_host_fsm
   assign speed_o           = cmd_speed;
   assign sample_en_d       = byte_starting | shift_en_o;
   assign full_cyc_o        = full_cyc;
-  assign cmd_end_o         = (byte_cntr_q == 'h1) & wr_en_o & sr_wr_ready_i;
+  assign cmd_end_o         = ((byte_cntr_q == 'h1) & wr_en_o & ~rd_en_o & sr_wr_ready_i) || ((byte_cntr_q == 'h0) & rd_en_o & sr_rd_ready_i);
 
   always_ff @(posedge clk_i or negedge rst_ni) begin
     if (!rst_ni) begin
-- 
2.16.5

